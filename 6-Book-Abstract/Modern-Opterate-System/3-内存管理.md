- 《现代操作系统》读摘

# 内存管理

- 帕金森定律：“不管存储器多大，程序都可以把它填满！”
- `分层存储体系`
- `存储管理器`

### 无存储器抽象

### 一种存储器抽象：地址空间

##### 地址空间的概念

- 保护和重定位
- `地址空间`：是一个进程可用于寻址内存的一套地址集合
- 每个进程都有一个自己的地址空间，并且这个地址空间独立于其它进程的地址空间

- 基址寄存器与界限寄存器
  - `动态重定位`：简单地把每个进程的地址空间映射到物理内存的不同部分
  - `基址寄存器`和`界限寄存器`

##### 交换技术

- `交换`是把一个进程完整调入内存，使该进程运行一段时间，然后把它存回磁盘
- `虚拟内存`：该策略甚至能使程序在只有一部分被调入内存的情况下运行
- `内存紧缩`：交换在内存中产生了多个空闲区，通过把所有的进程尽可能向下移动，有可能将这些小的空闲区合成一大块

##### 空闲内存管理

- `位图`和`空闲区链表`
- 使用链表的存储管理
  - 维护一个记录已经分配内存段和空闲内存段的链表
  - 链表中的每一个阶段都包含以下域：空闲区H或进程P的指示标志、起始地址、长度和指向下一节点的指针
  - `首次适配算法`：物理内存页管理器顺着双向链表进行搜索空闲内存区域，直到找到一个足够大的空闲区域，这是一种速度很快的算法，因为它尽可能少地搜索链表。
  - `下次适配算法`：工作方式和首次适配算法相同，不同点是每次找到合适的空闲区时都记录当时的位置，以便下次寻找空闲区时从上次结束的地方开始搜索，而不是享受此适配算法那样每次都从头开始
  - `最佳适配算法`：物理内存页管理器搜索整个双向链表（从开始到结束），找出能够满足申请分配的空间大小的最小空闲区域。
  - `最差适配算法`：物理内存页管理器搜索整个双向链表，找出能够满足申请分配的空间大小的最大空闲区域，使新的空闲区比较大从而可以继续使用。
  - `快速适配算法`：为那些常用大小的空闲区维护单独的链表。例如：4kb->8kb->12kb->...

### 虚拟内存

- `覆盖`：把程序分割成许多片段
- `虚拟内存`：使得应用程序认为它拥有连续可用的内存（一个连续完整的地址空间），而实际上，它通常是被分隔成多个物理内存碎片，还有部分暂时存储在外部磁盘存储器上，在需要时进行数据交换。

##### 分页

- 在使用虚拟内存的情况下，虚拟地址不是被直接送到内存总线上，而是被送到`内存管理单元`， MMU 把虚拟地址映射为物理地址。
- CPU中添加了能自动把虚拟内存（即逻辑地址）地址转化为物理内存地址的电路，为了简化这种电路，就把RAM划分为长度为4KB或8KB的块，这种块就叫`页框`。
- `缺页中断`或`缺页错误`

##### 页表

- 虚拟地址被分成`页号`和`偏移量`两部分
- 页表项的结构：
  - 一个典型的页表项：`| 。。。 | 高速缓存禁止位 | 访问位 | 修改位 | 保护位 | “在/不在 位” | 页框号 |`

##### 加速分页过程

- 主要考虑问题：
  - 1）虚拟地址到物理地址的映射必须非常快
  - 2）如果虚拟地址空间很大，页表也会很大
- 1. 转换检测缓冲区
  - `转换检测缓冲区`，又称`相连存储器`或`快表` TLB：是一个内存管理单元,用于改进虚拟地址到物理地址转换速度的缓存。如果没有TLB，则每次取数据都需要两次访问内存，即查页表获得物理地址和取数据。
- 2. 软件TLB管理
  - TLB失效：
    - 当一个页面访问在内存中而不再TLB中时，称为`软失效`
    - 当页面本身不在内存中（当然也不在TLB中）时，称为`硬失效`。此时需要一次磁盘存取已装入该页面，这个过程大概需要几毫秒。
  - 在页表结构中查找相应的映射被称为`页表遍历`
  - 三种缺页错误：
    - `次要缺页错误`：
    - `严重缺页错误`：
    - `段错误`：

##### 针对大内存的页表

- `多级页表`
- `倒排页表`

### 页面置换算法

##### 最优页面置换算法

##### 最近未使用页面置换算法 NRU （Not Recently Used）

##### 先进先出页面置换算法 FIFO （First-In First-Out）

##### 第二次机会页面置换算法

##### 时钟页面置换算法

##### 最近最少使用页面置换算法 LRU （Least Recently Used）

##### 用软件模拟LRU

##### 工作集页面置换算法

- `请求调页`：页面在进程需要时被调入内存，而不是预先装入
- `局部性访问`
- 一个进程当前在使用的页面的集合称为`工作集`
- 若每执行几条指令程序就发生一次缺页中断，那么就成这个程序发生了`颠簸`
- `工作集模型`：不少分页系统都会设法跟踪进程的工作集，以确保在让进程运行以前，它的工作集就已在内存中
- `预先调页`

##### 工作集时钟页面置换算法

##### 页面置换算法小结

算法 | 注释
- | -
最优算法 | 不可实现，但可用于基准
NRU（最近未使用）算法 | LRU的很粗糙的近似
FIFO（先进先出）算法 | 可能抛弃重要页面
第二次机会算法 | 比FIFO有较大改善
时钟算法 | 现实的
LRU（最近少使用）算法 | 很优秀，但很难实现
NFU（最不经常使用）算法 | LRU的相对粗略的近似
老化算法 | 非常近似LRU的有效算法
工作集算法 | 实现起来开销很大
工作集时钟算法 | 好的有效算法

- 实际工作中最好的是`老化算法`和`工作集时钟算法`

### 分页系统中的设计问题

##### 局部分配策略与全局分配策略

##### 负载控制

##### 页面大小

##### 分离的指令空间和数据空间

##### 共享页面

##### 共享库

##### 内存映射文件

##### 清除策略

##### 虚拟内存接口

### 有关实现的问题

##### 与分页有关的工作

##### 缺页中断处理

##### 指令备份

##### 锁定内存中的页面

##### 后备存储

##### 策略和机制的分离

### 分段

##### 纯分段的实现

##### 分段和分页结合：MULTICS

##### 分段和分页结合：Intel x86

### 有关内存管理的研究

### 小结
